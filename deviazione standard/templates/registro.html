<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Registro Calcoli Statistici</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  </head>
  <body>
    <!-- Add the fullscreen overlay container -->
    <div id="fullscreenOverlay" class="fullscreen-overlay">
      <div class="close-fullscreen">&times;</div>
      <img id="fullscreenImage" class="fullscreen-image" src="" alt="Fullscreen view">
    </div>

    <div class="container">
      <h1>Registro dei Calcoli Statistici</h1>
      
      <div class="registro">
        {% for calcolo in calcoli %}
        <div class="calcolo-card">
          <div class="calcolo-header">
            <h3>{{ calcolo.nome }}</h3>
            <span class="data">{{ calcolo.data_creazione.strftime('%d/%m/%Y %H:%M') }}</span>
          </div>
          
          <div class="calcolo-content">
            <p class="serie-nome">Serie: <strong>{{ calcolo.serie_nome }}</strong></p>
            
            {% if calcolo.statistiche %}
              {% set stats = calcolo.statistiche %}
              {% if not stats is mapping %}
                {% set stats = calcolo.statistiche|tojson|safe|from_json %}
              {% endif %}
              <div class="stats-container">
                <div class="stats-summary">
                  <details>
                    <summary>Statistiche Complete</summary>
                    <div class="stats-grid-compact">
                      <!-- Informazioni Dataset -->
                      <div class="stats-section">
                        <h4>Informazioni Dataset</h4>
                        <ul>
                          <li>Numero di valori: <strong>{{ stats.count }}</strong></li>
                        </ul>
                      </div>

                      <!-- Valori Principali -->
                      <div class="stats-section">
                        <h4>Valori Principali</h4>
                        <ul>
                          <li>Minimo: <strong>{{ "%.4f"|format(stats.min_max.min) }}</strong></li>
                          <li>Q1 (25° percentile): <strong>{{ "%.4f"|format(stats.quartili.Q1) }}</strong></li>
                          <li>Mediana (Q2): <strong>{{ "%.4f"|format(stats.mediana) }}</strong></li>
                          <li>Media: <strong>{{ "%.4f"|format(stats.media) }}</strong></li>
                          <li>Q3 (75° percentile): <strong>{{ "%.4f"|format(stats.quartili.Q3) }}</strong></li>
                          <li>Massimo: <strong>{{ "%.4f"|format(stats.min_max.max) }}</strong></li>
                        </ul>
                      </div>

                      <!-- Misure di Dispersione -->
                      <div class="stats-section">
                        <h4>Misure di Dispersione</h4>
                        <ul>
                          <li>Dev. Std. (pop.): <strong>{{ "%.4f"|format(stats.deviazione_standard_popolazione) }}</strong></li>
                          <li>Dev. Std. (camp.): <strong>{{ "%.4f"|format(stats.deviazione_standard_campione) }}</strong></li>
                          <li>Range: <strong>{{ "%.4f"|format(stats.range) }}</strong></li>
                        </ul>
                      </div>

                      <!-- Altri Indicatori -->
                      <div class="stats-section">
                        <h4>Altri Indicatori</h4>
                        <ul>
                          <li>Moda: 
                            <strong>
                              {% if stats.moda is string or stats.moda is number %}
                                {{ "%.4f"|format(stats.moda) }}
                              {% else %}
                                {% set formatted = [] %}
                                {% for x in stats.moda %}
                                  {% if formatted.append("%.4f"|format(x)) %}{% endif %}
                                {% endfor %}
                                {{ formatted|join(", ") }}
                              {% endif %}
                            </strong>
                          </li>
                          <li>Varianza (pop.): <strong>{{ "%.4f"|format(stats.varianza_popolazione) }}</strong></li>
                          <li>Varianza (camp.): <strong>{{ "%.4f"|format(stats.varianza_campione) }}</strong></li>
                        </ul>
                      </div>
                    </div>
                  </details>
                </div>
              </div>

              <!-- Add Visualizations Section -->
              {% if stats.plots %}
              <div class="visualizations-section">
                <h4>Visualizzazioni Statistiche</h4>
                <div class="plots-grid">
                  <!-- Histogram with KDE -->
                  <div class="plot-card">
                    <h5>Istogramma con KDE e Distribuzione Normale</h5>
                    <img src="data:image/png;base64,{{ stats.plots.histogram }}" alt="Histogram">
                  </div>
                  
                  <!-- Box Plot -->
                  <div class="plot-card">
                    <h5>Box Plot</h5>
                    <img src="data:image/png;base64,{{ stats.plots.boxplot }}" alt="Box Plot">
                  </div>
                  
                  <!-- Q-Q Plot -->
                  <div class="plot-card">
                    <h5>Q-Q Plot (Test di Normalità)</h5>
                    <img src="data:image/png;base64,{{ stats.plots.qqplot }}" alt="Q-Q Plot">
                  </div>
                </div>

                <!-- Correlation Matrix in separate section -->
                {% if calcolo.statistiche.plots.correlation %}
                <div class="correlation-matrix-section">
                  <h5>Matrice di Correlazione</h5>
                  <div class="correlation-container">
                    <div class="correlation-plot">
                      <img src="data:image/png;base64,{{ calcolo.statistiche.plots.correlation }}" alt="Correlation Matrix">
                    </div>
                    {% if calcolo.statistiche.legenda %}
                    <div class="correlation-legend">
                      <h4>Legenda delle Serie nella Matrice di Correlazione</h4>
                      <p class="legend-description">La matrice sopra utilizza lettere per rappresentare le serie di dati. Qui sotto trovi il significato di ogni lettera:</p>
                      <table class="legend-table">
                        <thead>
                          <tr>
                            <th>Etichetta</th>
                            <th>Nome Serie</th>
                          </tr>
                        </thead>
                        <tbody>
                        {% for lettera, nome in calcolo.statistiche.legenda.items() %}
                          <tr>
                            <td><strong>{{ lettera }}</strong></td>
                            <td>{{ nome }}</td>
                          </tr>
                        {% endfor %}
                        </tbody>
                      </table>
                    </div>
                    {% endif %}
                  </div>
                </div>
                {% endif %}
              </div>
              {% endif %}
            {% else %}
              <!-- Per retrocompatibilità con i vecchi calcoli -->
              <p>Deviazione Standard: <strong>{{ "%.4f"|format(calcolo.risultato) }}</strong></p>
            {% endif %}

            {% if calcolo.note %}
            <div class="note-box-compact">
              <strong>Note:</strong> {{ calcolo.note }}
            </div>
            {% endif %}
          </div>

          <div class="actions button-group">
            <a href="{{ url_for('modifica_calcolo', id=calcolo.id) }}" class="btn btn-edit" title="Modifica">
              <i class="fas fa-edit"></i>
              <span class="btn-text">Modifica</span>
            </a>
            <a href="{{ url_for('elimina_calcolo', id=calcolo.id) }}" class="btn btn-delete" 
               onclick="return confirm('Sei sicuro di voler eliminare questo calcolo?')"
               title="Elimina">
              <i class="fas fa-trash"></i>
              <span class="btn-text">Elimina</span>
            </a>
            <a href="{{ url_for('esporta_pdf', id=calcolo.id) }}" class="btn btn-export" title="Esporta PDF">
              <i class="fas fa-file-pdf"></i>
              <span class="btn-text">Esporta PDF</span>
            </a>
          </div>
        </div>
        {% endfor %}
      </div>
      
      <div class="actions center">
        <a href="{{ url_for('index') }}" class="btn">
          <i class="fas fa-home"></i>
          <span class="btn-text">Torna alla Home</span>
        </a>
      </div>
    </div>

    <script>
      // Add fullscreen functionality
      document.addEventListener('DOMContentLoaded', function() {
        const overlay = document.getElementById('fullscreenOverlay');
        const fullscreenImage = document.getElementById('fullscreenImage');
        const closeBtn = document.querySelector('.close-fullscreen');
        
        // Make all plot images clickable
        document.querySelectorAll('.plot-card img').forEach(img => {
          img.addEventListener('click', function() {
            fullscreenImage.src = this.src;
            overlay.classList.add('active');
          });
        });
        
        // Close on clicking overlay or close button
        overlay.addEventListener('click', function(e) {
          if (e.target === overlay || e.target === closeBtn) {
            overlay.classList.remove('active');
          }
        });
        
        // Close on ESC key
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape' && overlay.classList.contains('active')) {
            overlay.classList.remove('active');
          }
        });
      });
    </script>
  </body>
</html>